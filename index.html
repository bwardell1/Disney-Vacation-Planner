<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney World Itinerary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .tab-header {
            background-color: #e0e7ff; /* Indigo 100 */
            color: #4f46e5; /* Indigo 600 */
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem 0.75rem 0 0; /* Rounded top corners */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            margin-right: 0.25rem; /* Small gap between tabs */
            border: 1px solid #c7d2fe; /* Indigo 200 */
            border-bottom: none; /* No bottom border for tab effect */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Allow tabs to grow */
            min-width: 120px; /* Minimum width for each tab */
            text-align: center;
        }
        .tab-header:hover {
            background-color: #c7d2fe; /* Indigo 200 */
        }
        .tab-header.active {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-color: #6366f1; /* Match background */
            transform: translateY(-2px); /* Slight lift */
            z-index: 10; /* Bring active tab to front */
        }
        .tab-content-container {
            background-color: #fff;
            border-radius: 0 1rem 1rem 1rem; /* Rounded bottom and right top corner */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: -0.25rem; /* Overlap with tab headers */
            border: 1px solid #c7d2fe; /* Match tab border */
        }
        .detail-item strong {
            color: #4f46e5; /* Indigo 600 */
        }
        .list-item {
            margin-bottom: 0.25rem;
        }
        [contenteditable="true"] {
            outline: 1px dashed #a78bfa; /* Purple 300 for editable fields */
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            min-height: 1.5rem; /* Ensure visibility for empty editable fields */
        }
        [contenteditable="true"]:focus {
            outline: 2px solid #6d28d9; /* Deep purple on focus */
            background-color: #f5f3ff; /* Light purple background on focus */
        }
        .status-message {
            text-align: center;
            margin-top: 1rem;
            font-weight: 600;
            color: #10b981; /* Green 500 */
        }
        .status-message.error {
            color: #ef4444; /* Red 500 */
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold transition-all duration-200 ease-in-out;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 shadow-md;
        }
        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600 shadow-md;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .modal-input {
            width: calc(100% - 20px);
            padding: 0.5rem;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config provided by the user for GitHub hosting
        const firebaseConfig = {
            apiKey: "AIzaSyBUDwiaftNkP09VWy_r75YrCYdDKxOhrF0",
            authDomain: "disney-trip-app.firebaseapp.com",
            projectId: "disney-trip-app",
            storageBucket: "disney-trip-app.firebasestorage.app",
            messagingSenderId: "977685824042",
            appId: "1:977685824042:web:e6f7f405c107ad4f883953",
            measurementId: "G-CPQC346E90"
        };
        // Use projectId as the app_id for Firestore path, making it globally accessible
        const appId = firebaseConfig.projectId;


        // Global variables for Firebase instances and user ID
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.itineraryData = {}; // Global store for daily itinerary data
        window.tripOverview = {}; // Global store for trip overview data
        window.activeDayTab = null; // To keep track of the currently active tab

        // Declare DOM element variables globally
        let flightArrivalInfo;
        let flightDepartureInfo;
        let hotelInfoList;
        let carServiceInfo;
        let strollerRentalInfo;
        let dayTabsContainer;
        let itineraryDetails;
        let currentDayDate;
        let detailLocation;
        let detailParkHours;
        let detailLLTier1;
        let detailLLTier2;
        let detailILL;
        let detailRopeDrop;
        let detailSnacksList; // Changed to list
        let detailLunchDinnerList; // Changed to list
        let detailEveningShow;
        let userIdDisplay;
        let addHotelBtn;
        let addDayBtn;
        let removeDayBtn;
        let addSnackBtn; // New
        let addLunchDinnerBtn; // New


        // Debounce function to limit how often save operations are called
        let saveTimeout = null;
        window.debounceSave = (func, delay = 1000) => {
            return (...args) => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Function to update status messages
        window.updateStatus = (message, isError = false) => {
            const statusDiv = document.getElementById('status-message');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.classList.toggle('error', isError);
                statusDiv.classList.remove('hidden');
                // Hide after a few seconds unless it's an error
                if (!isError) {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }
        };

        // Helper function to format date from YYYY-MM-DD to Day of the week, Month-day-year
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            } catch (e) {
                console.error("Error formatting date:", dateString, e);
                return dateString; // Return original if formatting fails
            }
        }

        // Helper function to validate YYYY-MM-DD date format
        function isValidDate(dateString) {
            // Check for YYYY-MM-DD format
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) return false;

            const date = new Date(dateString);
            const timestamp = date.getTime();

            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) {
                return false; // Invalid date
            }

            // Check if the date components match the input string to prevent invalid dates like "2023-02-30"
            return date.toISOString().slice(0,10) === dateString;
        }

        // Custom Modal for prompts and confirmations
        function showModal(message, type = 'alert', callback = null) {
            let modal = document.getElementById('custom-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-modal';
                modal.classList.add('modal');
                document.body.appendChild(modal);
            }
            modal.innerHTML = `
                <div class="modal-content">
                    <p class="text-lg mb-4">${message}</p>
                    ${type === 'prompt' ? '<input type="text" id="modal-input" class="modal-input" placeholder="YYYY-MM-DD">' : ''}
                    <div class="modal-buttons">
                        ${type === 'confirm' || type === 'prompt' ? '<button id="modal-cancel" class="btn btn-secondary">Cancel</button>' : ''}
                        <button id="modal-ok" class="btn btn-primary">${type === 'alert' ? 'OK' : 'Confirm'}</button>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';

            document.getElementById('modal-ok').onclick = () => {
                modal.style.display = 'none';
                if (callback) {
                    if (type === 'prompt') {
                        const input = document.getElementById('modal-input').value;
                        callback(true, input);
                    } else {
                        callback(true);
                    }
                }
            };

            if (type === 'confirm' || type === 'prompt') {
                document.getElementById('modal-cancel').onclick = () => {
                    modal.style.display = 'none';
                    if (callback) callback(false);
                };
            }
            if (type === 'prompt') {
                document.getElementById('modal-input').focus();
            }
        }


        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Assign DOM elements here, ensuring they are available after the DOM loads
                flightArrivalInfo = document.getElementById('flight-arrival-info');
                flightDepartureInfo = document.getElementById('flight-departure-info');
                hotelInfoList = document.getElementById('hotel-info');
                carServiceInfo = document.getElementById('car-service-info');
                strollerRentalInfo = document.getElementById('stroller-rental-info');
                dayTabsContainer = document.getElementById('day-tabs');
                itineraryDetails = document.getElementById('itinerary-details');
                currentDayDate = document.getElementById('current-day-date');
                detailLocation = document.getElementById('detail-location');
                detailParkHours = document.getElementById('detail-park-hours');
                detailLLTier1 = document.getElementById('detail-ll-tier1');
                detailLLTier2 = document.getElementById('detail-ll-tier2');
                detailILL = document.getElementById('detail-ill');
                detailRopeDrop = document.getElementById('detail-rope-drop');
                detailSnacksList = document.getElementById('detail-snacks-list'); // Modified
                detailLunchDinnerList = document.getElementById('detail-lunch-dinner-list'); // Modified
                detailEveningShow = document.getElementById('detail-evening-show');
                userIdDisplay = document.getElementById('user-id-display');
                addHotelBtn = document.getElementById('add-hotel-btn');
                addDayBtn = document.getElementById('add-day-btn');
                removeDayBtn = document.getElementById('remove-day-btn');
                addSnackBtn = document.getElementById('add-snack-btn'); // New
                addLunchDinnerBtn = document.getElementById('add-lunch-dinner-btn'); // New


                // Attach event listeners for new buttons
                if (addHotelBtn) addHotelBtn.addEventListener('click', addHotel);
                if (addDayBtn) addDayBtn.addEventListener('click', addDay);
                if (removeDayBtn) removeDayBtn.addEventListener('click', removeDay);
                if (addSnackBtn) addSnackBtn.addEventListener('click', addSnackItem); // New
                if (addLunchDinnerBtn) addLunchDinnerBtn.addEventListener('click', addLunchDinnerItem); // New


                // For GitHub hosting, we'll always sign in anonymously as __initial_auth_token is Canvas-specific
                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        if (userIdDisplay) { // Check if element exists before setting textContent
                            userIdDisplay.textContent = `User ID: ${window.userId}`;
                        }
                        console.log("Firebase initialized and authenticated. User ID:", window.userId);
                        updateStatus("Loading itinerary...");
                        await loadItineraryFromFirestore(appId); // Pass appId to load function
                    } else {
                        console.log("No user signed in.");
                        window.userId = null;
                        if (userIdDisplay) { // Check if element exists before setting textContent
                            userIdDisplay.textContent = 'User ID: Not authenticated';
                        }
                        updateStatus("Not authenticated. Please refresh if issues persist.", true);
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                updateStatus(`Error initializing app: ${error.message}`, true);
            }
        }

        // Function to parse the initial CSV data
        // This data now comes from "Disney World Planning Info.xlsx - Intinerary.csv"
        const csvData = `DAY,7/24,7/25,7/26,7/27,7/28,7/29,07/30/2025
PARK/LOCATION,"Check In Day
Blizzard Beach","Check In Day
Typhoon Lagoon","Animal Kingdom
& Hollywood",Rest,Epcot,Magic Kingdom,Poly Pool
PARK HOURS,"10:00 AM to 7:00 PM","10:00 AM to 7:00 PM","7:30 AM to 7:00 pm
8:30 am to 9:00 pm",,"8:30 AM to 11 pm
Extended Evening","8:30 am to 11 pm",
Arrival Time,,,,,,,
Lightning Lane MultiPass,,,"Hollywood Studios
starting at Noon",,,,,
Tier 1,,,"Slinky Dog",,Test Track,Jungle Cruise,
Tier 2,,,"Toy Story Mania",,Spaceship Earth,Pirates,
Tier 2,,,"Earliest available Tier 2
(burner ride)",,"Nemo & Friends
(Burner Ride)","Magic Carpets of Aladdin (burner ride)",
Individual Lighting Lane,,,,Guardians?,Tron,
,,,,,
Rope Drop,,,"Flight of Passage",,Frozen,Peter Pan,
,,,,,
Snacks,,,,,,,
Top 3 Priorities,,,"AK - Satu'Ii
Cheeseburger Steamed Pods",,,,"Gaston's Tavern's Creme Brulee Croissant",,
,,,"AK - French Fries with Pulled Pork and Cheese - Flame Tree",,,,"Cheeseburger Spring Rolls - Adventure Land",,
,,,"HW - Ronto Wrap - Galxys Edge",,,,"Chipotle BBQ Loaded Fries - Casey's Corner",,
,,,,,,,"Corndog - Sleepy Hollow Refreshments",,
Lunch/Dinner,,,,,,,
Must-Do,,,"AK - Satu'li Canteen - Noodle Bowl
Cheeseburger Steamed Pods",,,,"Sleep Hollow - Chicke & Waffle",,
,,,,,,,"Cosmic Rays - Truffle French Onion Burger",,
,,,,,,,
,,,"Woody's Round up?",,,,,,
,,,"Woody's Lunch box?",,,,,,
,,,,,,,
,,,,,,,
Snack,,,,,,,
Evening Show,"Magic Kingdom Fireworks from Poly",,"Fantasmic: 9 pm
World of Ani: 9 pm",,Luminous: 9 pm,"Disney Starlight:
9 or 11 pm",`;

        function parseCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim());
            const parsedItinerary = {};
            // Trip overview data is NOT in this new CSV, so initialize as empty
            const parsedTripOverview = {
                arrivalFlight: { date: '', number: '', time: '' },
                departureFlight: { date: '', number: '', time: '' },
                hotels: [],
                carService: 'N/A',
                strollerRental: 'N/A'
            };

            // Row indices for daily itinerary based on the NEW CSV content (0-indexed)
            const DAY_ROW_IDX = 0;
            const PARK_LOCATION_ROW_IDX = 1;
            const PARK_HOURS_ROW_IDX = 2;
            const LIGHTNING_LANE_MULTIPASS_ROW_IDX = 4;
            const TIER1_ROW_IDX = 5;
            const TIER2_ROW_IDX_1 = 6;
            const TIER2_ROW_IDX_2 = 7;
            const INDIVIDUAL_LL_ROW_IDX = 8;
            const ROPE_DROP_ROW_IDX = 10;
            const SNACKS_HEADER_ROW_IDX = 12; // This is the "Snacks" header row
            const LUNCH_DINNER_HEADER_ROW_IDX = 17; // This is the "Lunch/Dinner" header row
            const EVENING_SHOW_ROW_IDX = 24; // This is the "Evening Show" header row


            // Helper to get cell value, handling empty strings and quoted commas
            const getCellValue = (rowIdx, col) => {
                const row = lines[rowIdx];
                if (!row) return '';
                // This regex handles commas inside double quotes
                const cells = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                return cells[col] || '';
            };


            const dayHeaders = lines[DAY_ROW_IDX].split(',').map(h => h.trim());

            const dayColumns = [];
            for (let i = 0; i < dayHeaders.length; i++) {
                // Adjust regex to match "7/24" or "07/30/2025" and convert to YYYY-MM-DD
                const dateMatch = dayHeaders[i].match(/(\d{1,2})\/(\d{1,2})(?:\/(\d{4}))?/);
                if (dateMatch) {
                    const month = dateMatch[1].padStart(2, '0');
                    const day = dateMatch[2].padStart(2, '0');
                    const year = dateMatch[3] || '2025'; // Assume 2025 if year is missing (e.g., "7/24")
                    const formattedDate = `${year}-${month}-${day}`;
                    dayColumns.push({ date: formattedDate, index: i });
                }
            }

            dayColumns.forEach(dayCol => {
                const date = dayCol.date;
                const colIdx = dayCol.index;

                const getListItems = (startIdx, endIdx, col) => {
                    const items = [];
                    for (let i = startIdx; i <= endIdx; i++) {
                        const item = getCellValue(i, col);
                        // Only add if item is not empty and not a header for the list
                        if (item && !['Snacks', 'Lunch/Dinner', 'Must-Do', 'Top 3 Priorities', 'Snack'].includes(item.trim())) {
                            items.push(item);
                        }
                    }
                    return items.filter(item => item !== '');
                };

                const location = getCellValue(PARK_LOCATION_ROW_IDX, colIdx);
                const parkHours = getCellValue(PARK_HOURS_ROW_IDX, colIdx);
                const lightningLaneMultipass = getCellValue(LIGHTNING_LANE_MULTIPASS_ROW_IDX, colIdx);
                const tier1 = getCellValue(TIER1_ROW_IDX, colIdx);
                const tier2_1 = getCellValue(TIER2_ROW_IDX_1, colIdx);
                const tier2_2 = getCellValue(TIER2_ROW_IDX_2, colIdx);
                const individualLL = getCellValue(INDIVIDUAL_LL_ROW_IDX, colIdx);
                const ropeDrop = getCellValue(ROPE_DROP_ROW_IDX, colIdx);
                const eveningShow = getCellValue(EVENING_SHOW_ROW_IDX, colIdx);

                // Determine the end index for snacks and lunch/dinner based on the actual content
                // The image shows "Top 3 Priorities" as a sub-header for snacks
                // And "Must-Do" as a sub-header for Lunch/Dinner
                // We need to find the actual content rows for snacks and lunch/dinner
                let currentSnacksEndIdx = LUNCH_DINNER_HEADER_ROW_IDX - 1;
                let currentLunchDinnerEndIdx = EVENING_SHOW_ROW_IDX - 1;

                // Find the actual end of the snacks list before the next header
                for (let i = SNACKS_HEADER_ROW_IDX + 1; i < LUNCH_DINNER_HEADER_ROW_IDX; i++) {
                    if (getCellValue(i, colIdx).trim() === '') {
                        currentSnacksEndIdx = i - 1;
                        break;
                    }
                    currentSnacksEndIdx = i; // Keep extending if there's content
                }

                // Find the actual end of the lunch/dinner list before the next header
                for (let i = LUNCH_DINNER_HEADER_ROW_IDX + 1; i < EVENING_SHOW_ROW_IDX; i++) {
                    if (getCellValue(i, colIdx).trim() === '') {
                        currentLunchDinnerEndIdx = i - 1;
                        break;
                    }
                    currentLunchDinnerEndIdx = i; // Keep extending if there's content
                }


                const snacks = getListItems(SNACKS_HEADER_ROW_IDX + 1, currentSnacksEndIdx, colIdx);
                const lunchDinner = getListItems(LUNCH_DINNER_HEADER_ROW_IDX + 1, currentLunchDinnerEndIdx, colIdx);

                parsedItinerary[date] = {
                    date: date,
                    location: location,
                    parkHours: parkHours,
                    lightningLaneMultipass: lightningLaneMultipass,
                    lightningLaneTiers: {
                        tier1: tier1,
                        tier2: [tier2_1, tier2_2].filter(Boolean).join('; ')
                    },
                    individualLightningLanes: individualLL,
                    ropeDrop: ropeDrop,
                    food: {
                        snacks: snacks,
                        lunchDinner: lunchDinner
                    },
                    eveningShow: eveningShow
                };
            });

            return { itinerary: parsedItinerary, tripOverview: parsedTripOverview };
        }

        // Function to save a specific part of the itinerary to Firestore
        window.saveDataToFirestore = window.debounceSave(async (dataType, dataKey, dataToSave) => {
            if (!window.userId || !window.db) {
                console.error("Firebase not initialized or user not authenticated. Cannot save data.");
                updateStatus("Error: Not authenticated. Cannot save.", true);
                return;
            }

            // Using projectId as the app_id for Firestore path
            const docRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/itineraryData`, dataKey);
            try {
                updateStatus("Saving...", false);
                await setDoc(docRef, dataToSave, { merge: true }); // Use merge to avoid overwriting the entire document
                updateStatus("Saved!", false);
                console.log(`Document ${dataKey} (${dataType}) successfully saved!`);
            } catch (e) {
                console.error(`Error saving document ${dataKey} (${dataType}): `, e);
                updateStatus(`Error saving: ${e.message}`, true);
            }
        });

        // Function to load all itinerary data from Firestore
        async function loadItineraryFromFirestore(appId) { // Accept appId as argument
            if (!window.userId || !window.db) {
                console.error("Firebase not initialized or user not authenticated. Cannot load data.");
                return;
            }

            const itineraryCollectionRef = collection(window.db, `artifacts/${appId}/users/${window.userId}/itineraryData`);

            try {
                // Listen for changes to trip overview
                onSnapshot(doc(itineraryCollectionRef, "tripOverview"), (docSnap) => {
                    if (docSnap.exists()) {
                        window.tripOverview = docSnap.data();
                        console.log("Trip Overview loaded from Firestore:", window.tripOverview);
                        populateTripOverview(window.tripOverview);
                        updateStatus("Itinerary loaded.");
                    } else {
                        console.log("No trip overview found in Firestore. Using initial CSV data.");
                        const { itinerary: csvItinerary, tripOverview: csvTripOverview } = parseCSV(csvData);
                        window.tripOverview = csvTripOverview;
                        populateTripOverview(window.tripOverview);
                        // Save initial CSV data to Firestore if not present
                        window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);
                    }
                }, (error) => {
                    console.error("Error listening to trip overview:", error);
                    updateStatus(`Error loading trip overview: ${error.message}`, true);
                });

                // Listen for changes to daily itineraries
                onSnapshot(itineraryCollectionRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const docId = change.doc.id;
                        if (docId === "tripOverview") return; // Skip trip overview here

                        if (change.type === "added" || change.type === "modified") {
                            window.itineraryData[docId] = change.doc.data();
                            console.log(`Daily itinerary for ${docId} loaded/updated.`);
                            // If the current tab is the one being updated, re-display it
                            if (window.activeDayTab && window.activeDayTab.dataset.date === docId) {
                                displayDayDetails(docId);
                            }
                        } else if (change.type === "removed") {
                            delete window.itineraryData[docId];
                            console.log(`Daily itinerary for ${docId} removed.`);
                            // If the removed tab was active, clear details
                            if (window.activeDayTab && window.activeDayTab.dataset.date === docId) {
                                displayDayDetails(null); // Clear content
                            }
                        }
                    });

                    // Re-render tabs if new dates are added or removed
                    renderDayTabs();

                    // If no tab is active, or the active tab was removed, activate the first one
                    if (!window.activeDayTab || !window.itineraryData[window.activeDayTab.dataset.date]) {
                        const sortedDates = Object.keys(window.itineraryData).sort();
                        if (sortedDates.length > 0) {
                            const firstTabHeader = document.querySelector(`.tab-header[data-date="${sortedDates[0]}"]`);
                            if (firstTabHeader) {
                                firstTabHeader.click();
                            }
                        } else {
                            displayDayDetails(null); // Clear if no data
                        }
                    }
                    updateStatus("Itinerary loaded.");

                }, (error) => {
                    console.error("Error listening to daily itineraries:", error);
                    updateStatus(`Error loading daily itineraries: ${error.message}`, true);
                });

                // Initial load: if no data in Firestore, populate from CSV and save
                const initialDocs = await getDocs(itineraryCollectionRef);
                if (initialDocs.empty) {
                    console.log("No data in Firestore. Populating from CSV and saving.");
                    const { itinerary: csvItinerary, tripOverview: csvTripOverview } = parseCSV(csvData);
                    window.tripOverview = csvTripOverview;
                    window.itineraryData = csvItinerary;

                    // Save trip overview
                    window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);

                    // Save each daily itinerary
                    for (const date in window.itineraryData) {
                        window.saveDataToFirestore('dailyItinerary', date, window.itineraryData[date]);
                    }
                    populateTripOverview(window.tripOverview);
                    renderDayTabs();
                    const sortedDates = Object.keys(window.itineraryData).sort();
                    if (sortedDates.length > 0) {
                        const firstTabHeader = document.querySelector(`.tab-header[data-date="${sortedDates[0]}"]`);
                        if (firstTabHeader) {
                            firstTabHeader.click();
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading itinerary from Firestore:", error);
                updateStatus(`Error loading itinerary: ${error.message}`, true);
            }
        }

        // Function to populate trip overview details
        function populateTripOverview(data) {
            if (flightArrivalInfo) { // Ensure element exists
                if (data.arrivalFlight) {
                    flightArrivalInfo.textContent = `${data.arrivalFlight.number || 'N/A'} on ${data.arrivalFlight.date || 'N/A'} at ${data.arrivalFlight.time || 'N/A'}`;
                } else {
                    flightArrivalInfo.textContent = 'N/A';
                }
            }

            if (flightDepartureInfo) { // Ensure element exists
                if (data.departureFlight) {
                    flightDepartureInfo.textContent = `${data.departureFlight.number || 'N/A'} on ${data.departureFlight.date || 'N/A'} at ${data.departureFlight.time || 'N/A'}`;
                } else {
                    flightDepartureInfo.textContent = 'N/A';
                }
            }

            if (hotelInfoList) { // Ensure element exists
                hotelInfoList.innerHTML = ''; // Clear existing
                if (data.hotels && data.hotels.length > 0) {
                    data.hotels.forEach((hotel, index) => {
                        const li = document.createElement('li');
                        li.classList.add('list-item', 'flex', 'items-center', 'gap-2'); // Add flex for layout
                        li.innerHTML = `
                            <span class="font-semibold" contenteditable="true" data-field="hotel-name" data-index="${index}">${hotel.name || 'N/A'}</span>
                            (<span contenteditable="true" data-field="hotel-dates" data-index="${index}">${hotel.dates || 'N/A'}</span>) -
                            Confirmation: <span contenteditable="true" data-field="hotel-confirmation" data-index="${index}">${hotel.confirmation || 'N/A'}</span>
                            <button class="remove-item-btn btn-danger text-sm p-1 ml-2" data-type="hotel" data-index="${index}">x</button>
                        `;
                        hotelInfoList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.classList.add('list-item');
                    li.textContent = 'No hotel information added yet.';
                    hotelInfoList.appendChild(li);
                }
            }

            if (carServiceInfo) carServiceInfo.textContent = data.carService || 'N/A';
            if (strollerRentalInfo) strollerRentalInfo.textContent = data.strollerRental || 'N/A';

            // Add event listeners for contenteditable fields
            document.querySelectorAll('#trip-overview [contenteditable="true"]').forEach(element => {
                element.removeEventListener('blur', handleOverviewEdit); // Prevent duplicate listeners
                element.addEventListener('blur', handleOverviewEdit);
            });

            // Add event listeners for remove hotel buttons
            document.querySelectorAll('#hotel-info .remove-item-btn').forEach(button => {
                button.removeEventListener('click', removeHotel); // Prevent duplicate listeners
                button.addEventListener('click', removeHotel);
            });
        }

        // Handle editing of trip overview fields
        function handleOverviewEdit(event) {
            const field = event.target.dataset.field;
            const index = event.target.dataset.index; // For hotels
            let value = event.target.textContent.trim();

            if (!window.tripOverview) {
                window.tripOverview = {};
            }

            if (field === 'hotel-name' || field === 'hotel-dates' || field === 'hotel-confirmation') {
                if (!window.tripOverview.hotels) {
                    window.tripOverview.hotels = [];
                }
                while (window.tripOverview.hotels.length <= index) {
                    window.tripOverview.hotels.push({ name: '', dates: '', confirmation: '' });
                }
                const hotel = window.tripOverview.hotels[index];
                if (field === 'hotel-name') hotel.name = value;
                if (field === 'hotel-dates') hotel.dates = value;
                if (field === 'hotel-confirmation') hotel.confirmation = value;
            } else if (field === 'arrival-flight-date') {
                if (!window.tripOverview.arrivalFlight) window.tripOverview.arrivalFlight = {};
                window.tripOverview.arrivalFlight.date = value;
            } else if (field === 'arrival-flight-number') {
                if (!window.tripOverview.arrivalFlight) window.tripOverview.arrivalFlight = {};
                window.tripOverview.arrivalFlight.number = value;
            } else if (field === 'arrival-flight-time') {
                if (!window.tripOverview.arrivalFlight) window.tripOverview.arrivalFlight = {};
                window.tripOverview.arrivalFlight.time = value;
            } else if (field === 'departure-flight-date') {
                if (!window.tripOverview.departureFlight) window.tripOverview.departureFlight = {};
                window.tripOverview.departureFlight.date = value;
            } else if (field === 'departure-flight-number') {
                if (!window.tripOverview.departureFlight) window.tripOverview.departureFlight = {};
                window.tripOverview.departureFlight.number = value;
            } else if (field === 'departure-flight-time') {
                if (!window.tripOverview.departureFlight) window.tripOverview.departureFlight = {};
                window.tripOverview.departureFlight.time = value;
            } else if (field === 'car-service-info') {
                window.tripOverview.carService = value;
            } else if (field === 'stroller-rental-info') {
                window.tripOverview.strollerRental = value;
            }
            window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);
        }

        // Add new hotel entry
        function addHotel() {
            if (!window.tripOverview.hotels) {
                window.tripOverview.hotels = [];
            }
            window.tripOverview.hotels.push({ name: 'New Hotel', dates: 'Dates', confirmation: 'Confirmation #' });
            populateTripOverview(window.tripOverview); // Re-render to show new hotel
            window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);
        }

        // Remove hotel entry
        function removeHotel(event) {
            const index = parseInt(event.target.dataset.index);
            if (window.tripOverview.hotels && window.tripOverview.hotels.length > index) {
                showModal('Are you sure you want to remove this hotel entry?', 'confirm', (result) => {
                    if (result) {
                        window.tripOverview.hotels.splice(index, 1);
                        populateTripOverview(window.tripOverview);
                        window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);
                        updateStatus('Hotel entry removed.');
                    }
                });
            }
        }

        // Function to create a new day tab
        function createDayTab(date) {
            const tabHeader = document.createElement('div');
            tabHeader.classList.add('tab-header', 'px-4', 'py-2', 'rounded-t-lg', 'cursor-pointer');
            tabHeader.dataset.date = date; // Store the full date in data-date attribute
            tabHeader.textContent = formatDate(date).split(',')[0]; // Display only the day of the week
            tabHeader.onclick = () => activateDayTab(tabHeader);
            return tabHeader;
        }

        // Function to render all day tabs
        function renderDayTabs() {
            if (!dayTabsContainer) return;
            dayTabsContainer.innerHTML = ''; // Clear existing tabs
            const sortedDates = Object.keys(window.itineraryData).sort(); // Sort dates
            sortedDates.forEach(date => {
                dayTabsContainer.appendChild(createDayTab(date));
            });

            // Re-activate the previously active tab or the first one
            if (window.activeDayTab) {
                const reActivateTab = document.querySelector(`.tab-header[data-date="${window.activeDayTab.dataset.date}"]`);
                if (reActivateTab) {
                    activateDayTab(reActivateTab);
                } else if (sortedDates.length > 0) {
                    // If the active tab was removed, activate the first available tab
                    document.querySelector(`.tab-header[data-date="${sortedDates[0]}"]`).click();
                } else {
                    displayDayDetails(null); // No tabs left
                }
            } else if (sortedDates.length > 0) {
                document.querySelector(`.tab-header[data-date="${sortedDates[0]}"]`).click();
            }
        }

        // Function to activate a day tab
        function activateDayTab(tabHeader) {
            if (window.activeDayTab) {
                window.activeDayTab.classList.remove('active', 'bg-indigo-600', 'text-white', 'shadow-md', 'border-indigo-600', 'transform', 'translateY(-2px)');
                window.activeDayTab.classList.add('bg-indigo-100', 'text-indigo-600', 'border-indigo-200');
            }
            tabHeader.classList.add('active', 'bg-indigo-600', 'text-white', 'shadow-md', 'border-indigo-600', 'transform', 'translateY(-2px)');
            tabHeader.classList.remove('bg-indigo-100', 'text-indigo-600', 'border-indigo-200');
            window.activeDayTab = tabHeader;
            displayDayDetails(tabHeader.dataset.date);
        }

        // Function to display daily itinerary details
        function displayDayDetails(date) {
            if (!itineraryDetails) return; // Ensure element exists

            if (!date || !window.itineraryData[date]) {
                itineraryDetails.innerHTML = '<p class="text-gray-600">Select a day or add a new day to view details.</p>';
                currentDayDate.textContent = 'No Day Selected';
                return;
            }

            const dayData = window.itineraryData[date];
            currentDayDate.textContent = formatDate(dayData.date);

            // Set text content for simple fields
            detailLocation.textContent = dayData.location || '';
            detailParkHours.textContent = dayData.parkHours || '';
            detailLLTier1.textContent = dayData.lightningLaneTiers.tier1 || '';
            detailLLTier2.textContent = dayData.lightningLaneTiers.tier2 || '';
            detailILL.textContent = dayData.individualLightningLanes || '';
            detailRopeDrop.textContent = dayData.ropeDrop || '';
            detailEveningShow.textContent = dayData.eveningShow || '';

            // Populate snack list
            detailSnacksList.innerHTML = ''; // Clear existing
            if (dayData.food.snacks && dayData.food.snacks.length > 0) {
                dayData.food.snacks.forEach((snack, index) => {
                    const li = document.createElement('li');
                    li.classList.add('list-item', 'flex', 'items-center', 'gap-2');
                    li.innerHTML = `
                        <span contenteditable="true" data-field="snack" data-index="${index}">${snack}</span>
                        <button class="remove-item-btn btn-danger text-sm p-1 ml-2" data-type="snack" data-index="${index}">x</button>
                    `;
                    detailSnacksList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.classList.add('list-item', 'text-gray-500');
                li.textContent = 'No snacks added yet.';
                detailSnacksList.appendChild(li);
            }

            // Populate lunch/dinner list
            detailLunchDinnerList.innerHTML = ''; // Clear existing
            if (dayData.food.lunchDinner && dayData.food.lunchDinner.length > 0) {
                dayData.food.lunchDinner.forEach((meal, index) => {
                    const li = document.createElement('li');
                    li.classList.add('list-item', 'flex', 'items-center', 'gap-2');
                    li.innerHTML = `
                        <span contenteditable="true" data-field="lunchDinner" data-index="${index}">${meal}</span>
                        <button class="remove-item-btn btn-danger text-sm p-1 ml-2" data-type="lunchDinner" data-index="${index}">x</button>
                    `;
                    detailLunchDinnerList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.classList.add('list-item', 'text-gray-500');
                li.textContent = 'No lunch/dinner items added yet.';
                detailLunchDinnerList.appendChild(li);
            }


            // Add event listeners for contenteditable fields
            document.querySelectorAll('#itinerary-details [contenteditable="true"]').forEach(element => {
                element.removeEventListener('blur', saveItineraryDetails); // Prevent duplicate listeners
                element.addEventListener('blur', saveItineraryDetails);
            });

            // Add event listeners for remove item buttons for snacks and lunch/dinner
            document.querySelectorAll('#itinerary-details .remove-item-btn').forEach(button => {
                button.removeEventListener('click', removeDayItem); // Prevent duplicate listeners
                button.addEventListener('click', removeDayItem);
            });
        }


        // Function to save daily itinerary details
        function saveItineraryDetails(event) {
            if (!window.activeDayTab || !window.activeDayTab.dataset.date) {
                console.warn("No active day tab selected. Cannot save daily details.");
                updateStatus("Error: No day selected for saving.", true);
                return;
            }

            const date = window.activeDayTab.dataset.date;
            const dayData = window.itineraryData[date];

            // Update simple fields directly
            dayData.location = detailLocation.textContent.trim();
            dayData.parkHours = detailParkHours.textContent.trim();
            dayData.lightningLaneTiers.tier1 = detailLLTier1.textContent.trim();
            dayData.lightningLaneTiers.tier2 = detailLLTier2.textContent.trim();
            dayData.individualLightningLanes = detailILL.textContent.trim();
            dayData.ropeDrop = detailRopeDrop.textContent.trim();
            dayData.eveningShow = detailEveningShow.textContent.trim();

            // Update dynamic lists
            dayData.food.snacks = Array.from(detailSnacksList.children)
                                    .filter(li => li.querySelector('span[contenteditable="true"]'))
                                    .map(li => li.querySelector('span[contenteditable="true"]').textContent.trim())
                                    .filter(text => text !== ''); // Filter out empty strings

            dayData.food.lunchDinner = Array.from(detailLunchDinnerList.children)
                                        .filter(li => li.querySelector('span[contenteditable="true"]'))
                                        .map(li => li.querySelector('span[contenteditable="true"]').textContent.trim())
                                        .filter(text => text !== ''); // Filter out empty strings

            window.itineraryData[date] = dayData;
            window.saveDataToFirestore('dailyItinerary', date, dayData);
        }

        // Add new snack item
        function addSnackItem() {
            if (!window.activeDayTab || !window.activeDayTab.dataset.date) {
                showModal("Please select a day tab first to add a snack.", 'alert');
                return;
            }
            const date = window.activeDayTab.dataset.date;
            if (!window.itineraryData[date].food.snacks) {
                window.itineraryData[date].food.snacks = [];
            }
            window.itineraryData[date].food.snacks.push("New Snack Item");
            displayDayDetails(date); // Re-render to show new item
            saveItineraryDetails(); // Save changes
        }

        // Add new lunch/dinner item
        function addLunchDinnerItem() {
            if (!window.activeDayTab || !window.activeDayTab.dataset.date) {
                showModal("Please select a day tab first to add a lunch/dinner item.", 'alert');
                return;
            }
            const date = window.activeDayTab.dataset.date;
            if (!window.itineraryData[date].food.lunchDinner) {
                window.itineraryData[date].food.lunchDinner = [];
            }
            window.itineraryData[date].food.lunchDinner.push("New Meal Item");
            displayDayDetails(date); // Re-render to show new item
            saveItineraryDetails(); // Save changes
        }

        // Remove snack or lunch/dinner item
        function removeDayItem(event) {
            const itemType = event.target.dataset.type; // 'snack' or 'lunchDinner'
            const index = parseInt(event.target.dataset.index);
            const date = window.activeDayTab.dataset.date;

            if (date && window.itineraryData[date] && window.itineraryData[date].food) {
                showModal(`Are you sure you want to remove this ${itemType} entry?`, 'confirm', (result) => {
                    if (result) {
                        if (itemType === 'snack' && window.itineraryData[date].food.snacks) {
                            window.itineraryData[date].food.snacks.splice(index, 1);
                        } else if (itemType === 'lunchDinner' && window.itineraryData[date].food.lunchDinner) {
                            window.itineraryData[date].food.lunchDinner.splice(index, 1);
                        }
                        displayDayDetails(date); // Re-render to update the list
                        saveItineraryDetails(); // Save changes
                        updateStatus(`${itemType} entry removed.`);
                    }
                });
            }
        }


        // Add a new day to the itinerary
        function addDay() {
            showModal('Enter the new date (YYYY-MM-DD):', 'prompt', (confirmed, dateInput) => {
                if (confirmed && dateInput) {
                    const newDate = dateInput.trim();
                    if (!isValidDate(newDate)) {
                        showModal('Invalid date format. Please use YYYY-MM-DD.', 'alert');
                        return;
                    }
                    if (window.itineraryData[newDate]) {
                        showModal(`A day for ${newDate} already exists.`, 'alert');
                        return;
                    }

                    // Add new day with default empty structure
                    window.itineraryData[newDate] = {
                        date: newDate,
                        location: 'New Location',
                        parkHours: '',
                        lightningLaneMultipass: '',
                        lightningLaneTiers: { tier1: '', tier2: '' },
                        individualLightningLanes: '',
                        ropeDrop: '',
                        food: { snacks: [], lunchDinner: [] }, // Initialize as empty arrays
                        eveningShow: ''
                    };
                    renderDayTabs(); // Re-render to show the new tab
                    document.querySelector(`.tab-header[data-date="${newDate}"]`).click(); // Activate new tab
                    window.saveDataToFirestore('dailyItinerary', newDate, window.itineraryData[newDate]);
                    updateStatus(`Day for ${newDate} added!`);
                }
            });
        }

        // Remove a day from the itinerary
        function removeDay() {
            if (!window.activeDayTab || !window.activeDayTab.dataset.date) {
                showModal('Please select a day tab to remove.', 'alert');
                return;
            }
            const dateToRemove = window.activeDayTab.dataset.date;

            showModal(`Are you sure you want to remove the itinerary for ${formatDate(dateToRemove)}? This cannot be undone.`, 'confirm', async (confirmed) => {
                if (confirmed) {
                    try {
                        const docRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/itineraryData`, dateToRemove);
                        await deleteDoc(docRef);
                        delete window.itineraryData[dateToRemove]; // Remove from local state
                        renderDayTabs(); // Re-render tabs
                        updateStatus(`Day for ${dateToRemove} removed.`);
                        console.log("Document successfully deleted!");
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        updateStatus(`Error removing day: ${error.message}`, true);
                    }
                }
            });
        }

        // Initialize Firebase when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</head>
<body class="bg-gray-100 text-gray-800 p-4">
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8">Disney World Itinerary Planner</h1>

        <div id="status-message" class="status-message hidden px-4 py-2 rounded-lg mb-4"></div>

        <div id="user-id-display" class="text-sm text-gray-500 text-center mb-6">Loading User ID...</div>

        <div id="trip-overview" class="card">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Trip Overview</h2>
            <div class="space-y-3 text-lg">
                <div class="detail-item">
                    <strong>Arrival Flight:</strong>
                    <span contenteditable="true" data-field="arrival-flight-number" class="inline-block min-w-[50px]">${window.tripOverview.arrivalFlight?.number || 'N/A'}</span> on
                    <span contenteditable="true" data-field="arrival-flight-date" class="inline-block min-w-[100px]">${window.tripOverview.arrivalFlight?.date || 'N/A'}</span> at
                    <span contenteditable="true" data-field="arrival-flight-time" class="inline-block min-w-[70px]">${window.tripOverview.arrivalFlight?.time || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <strong>Departure Flight:</strong>
                    <span contenteditable="true" data-field="departure-flight-number" class="inline-block min-w-[50px]">${window.tripOverview.departureFlight?.number || 'N/A'}</span> on
                    <span contenteditable="true" data-field="departure-flight-date" class="inline-block min-w-[100px]">${window.tripOverview.departureFlight?.date || 'N/A'}</span> at
                    <span contenteditable="true" data-field="departure-flight-time" class="inline-block min-w-[70px]">${window.tripOverview.departureFlight?.time || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <strong>Hotels:</strong>
                    <ul id="hotel-info" class="list-disc list-inside mt-1 ml-4">
                        </ul>
                    <button id="add-hotel-btn" class="btn btn-secondary text-sm mt-2">Add Hotel</button>
                </div>
                <div class="detail-item">
                    <strong>Car Service:</strong> <span id="car-service-info" contenteditable="true" data-field="car-service-info">${window.tripOverview.carService || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <strong>Stroller Rental:</strong> <span id="stroller-rental-info" contenteditable="true" data-field="stroller-rental-info">${window.tripOverview.strollerRental || 'N/A'}</span>
                </div>
            </div>
        </div>

        <div class="card p-0 mt-8">
            <div class="flex flex-wrap justify-start border-b border-indigo-200 -mb-px" id="day-tabs">
                </div>

            <div class="tab-content-container p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-indigo-600" id="current-day-date">Select a Day</h2>
                    <div>
                        <button id="add-day-btn" class="btn btn-primary mr-2">Add Day</button>
                        <button id="remove-day-btn" class="btn btn-danger">Remove Day</button>
                    </div>
                </div>

                <div id="itinerary-details" class="space-y-4 text-lg">
                    <p class="text-gray-600">Select a day tab to view and edit its details.</p>
                    <div class="detail-item"><strong>Location:</strong> <span id="detail-location" contenteditable="true"></span></div>
                    <div class="detail-item"><strong>Park Hours:</strong> <span id="detail-park-hours" contenteditable="true"></span></div>
                    <div class="detail-item"><strong>Lightning Lane MultiPass:</strong> <span id="detail-ll-multipass" contenteditable="true"></span></div>
                    <div class="detail-item"><strong>Lightning Lane Tier 1:</strong> <span id="detail-ll-tier1" contenteditable="true"></span></div>
                    <div class="detail-item"><strong>Lightning Lane Tier 2:</strong> <span id="detail-ll-tier2" contenteditable="true"></span></div>
                    <div class="detail-item"><strong>Individual Lightning Lane:</strong> <span id="detail-ill" contenteditable="true"></span></div>
                    <div class="detail-item"><strong>Rope Drop:</strong> <span id="detail-rope-drop" contenteditable="true"></span></div>

                    <div class="detail-item">
                        <strong>Snacks:</strong>
                        <ul id="detail-snacks-list" class="list-disc list-inside mt-1 ml-4">
                            </ul>
                        <button id="add-snack-btn" class="btn btn-secondary text-sm mt-2">Add Snack</button>
                    </div>

                    <div class="detail-item">
                        <strong>Lunch/Dinner:</strong>
                        <ul id="detail-lunch-dinner-list" class="list-disc list-inside mt-1 ml-4">
                            </ul>
                        <button id="add-lunch-dinner-btn" class="btn btn-secondary text-sm mt-2">Add Lunch/Dinner</button>
                    </div>

                    <div class="detail-item"><strong>Evening Show:</strong> <span id="detail-evening-show" contenteditable="true"></span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal hidden"></div>
</body>
</html>
