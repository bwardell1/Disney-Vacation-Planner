<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney World Itinerary</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .tab-header {
            background-color: #e0e7ff; /* Indigo 100 */
            color: #4f46e5; /* Indigo 600 */
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem 0.75rem 0 0; /* Rounded top corners */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            margin-right: 0.25rem; /* Small gap between tabs */
            border: 1px solid #c7d2fe; /* Indigo 200 */
            border-bottom: none; /* No bottom border for tab effect */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Allow tabs to grow */
            min-width: 120px; /* Minimum width for each tab */
            text-align: center;
        }
        .tab-header:hover {
            background-color: #c7d2fe; /* Indigo 200 */
        }
        .tab-header.active {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-color: #6366f1; /* Match background */
            transform: translateY(-2px); /* Slight lift */
            z-index: 10; /* Bring active tab to front */
        }
        .tab-content-container {
            background-color: #fff;
            border-radius: 0 1rem 1rem 1rem; /* Rounded bottom and right top corner */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: -0.25rem; /* Overlap with tab headers */
            border: 1px solid #c7d2fe; /* Match tab border */
        }
        .detail-item strong {
            color: #4f46e5; /* Indigo 600 */
        }
        .list-item {
            margin-bottom: 0.25rem;
        }
        [contenteditable="true"] {
            outline: 1px dashed #a78bfa; /* Purple 300 for editable fields */
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            min-height: 1.5rem; /* Ensure visibility for empty editable fields */
        }
        [contenteditable="true"]:focus {
            outline: 2px solid #6d28d9; /* Deep purple on focus */
            background-color: #f5f3ff; /* Light purple background on focus */
        }
        .status-message {
            text-align: center;
            margin-top: 1rem;
            font-weight: 600;
            color: #10b981; /* Green 500 */
        }
        .status-message.error {
            color: #ef4444; /* Red 500 */
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.itineraryData = {}; // Global store for daily itinerary data
        window.tripOverview = {}; // Global store for trip overview data
        window.activeDayTab = null; // To keep track of the currently active tab

        // Declare DOM element variables globally
        let flightArrivalInfo;
        let flightDepartureInfo;
        let hotelInfoList;
        let carServiceInfo;
        let strollerRentalInfo;
        let dayTabsContainer;
        let itineraryDetails;
        let currentDayDate;
        let detailLocation;
        let detailParkHours;
        let detailLLTier1;
        let detailLLTier2;
        let detailILL;
        let detailRopeDrop;
        let detailSnacks;
        let detailLunchDinner;
        let detailEveningShow;
        let userIdDisplay;


        // Debounce function to limit how often save operations are called
        let saveTimeout = null;
        window.debounceSave = (func, delay = 1000) => {
            return (...args) => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Function to update status messages
        window.updateStatus = (message, isError = false) => {
            const statusDiv = document.getElementById('status-message');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.classList.toggle('error', isError);
                statusDiv.classList.remove('hidden');
                // Hide after a few seconds unless it's an error
                if (!isError) {
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                    }, 3000);
                }
            }
        };

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize Firebase.");
                    updateStatus("Error: Firebase configuration missing.", true);
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Assign DOM elements here, ensuring they are available after the DOM loads
                flightArrivalInfo = document.getElementById('flight-arrival-info');
                flightDepartureInfo = document.getElementById('flight-departure-info');
                hotelInfoList = document.getElementById('hotel-info');
                carServiceInfo = document.getElementById('car-service-info');
                strollerRentalInfo = document.getElementById('stroller-rental-info');
                dayTabsContainer = document.getElementById('day-tabs');
                itineraryDetails = document.getElementById('itinerary-details');
                currentDayDate = document.getElementById('current-day-date');
                detailLocation = document.getElementById('detail-location');
                detailParkHours = document.getElementById('detail-park-hours');
                detailLLTier1 = document.getElementById('detail-ll-tier1');
                detailLLTier2 = document.getElementById('detail-ll-tier2');
                detailILL = document.getElementById('detail-ill');
                detailRopeDrop = document.getElementById('detail-rope-drop');
                detailSnacks = document.getElementById('detail-snacks');
                detailLunchDinner = document.getElementById('detail-lunch-dinner');
                detailEveningShow = document.getElementById('detail-evening-show');
                userIdDisplay = document.getElementById('user-id-display');


                // Sign in using custom token if available, otherwise anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        if (userIdDisplay) { // Check if element exists before setting textContent
                            userIdDisplay.textContent = `User ID: ${window.userId}`;
                        }
                        console.log("Firebase initialized and authenticated. User ID:", window.userId);
                        updateStatus("Loading itinerary...");
                        await loadItineraryFromFirestore();
                    } else {
                        console.log("No user signed in.");
                        window.userId = null;
                        if (userIdDisplay) { // Check if element exists before setting textContent
                            userIdDisplay.textContent = 'User ID: Not authenticated';
                        }
                        updateStatus("Not authenticated. Please refresh if issues persist.", true);
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                updateStatus(`Error initializing app: ${error.message}`, true);
            }
        }

        // Function to parse the initial CSV data
        const csvData = `Our Disney Trip,,,,,,,,,,,,,
Flight # ,Arrival,2025-07-23,UA2451,18:25:00,,,,General Park Hours,Open,Close,,,
Flight #,Departure,2025-07-30,UA1818,19:18:00,,,,Magic Kingdom,08:30:00,23:00:00,,,
Hotel Confirmation,Sheraton Suites Airport,"1394156560
H-CQMG6XC297WB",2025-07-23,,,,,Epcot,08:30:00,21:00:00,,,
Hotel Confirmation,All Star Music,WDW App,2025-07-24,,,,,Hollywood,08:30:00,21:00:00,,,
Hotel Confirmation,Polyuneasian,WDW App,Fri 7/25- Wed 7/30,,,,,Animal Kingdom,07:30:00,18:00:00,,,
Car Service,Uber/Lyft,,,,,,,,,,,,
Stroller Rental,"Baby Quip 
7/24/25 6-8 am Poly",,,,,,,,,,,,
DAY,2025-07-24,,2025-07-25,,2025-07-26,,2025-07-27,,2025-07-28,,2025-07-29,,2025-07-30
PARK/LOCATION,"Check In Day
Blizzard Beach",,"Check In Day
Typhoon Lagoon",,"Animal Kingdom
& Hollywood",,Rest,,Epcot,,Magic Kingdom,,Poly Pool
PARK HOURS,10:00 AM to 7:00 PM,,10:00 AM to 7:00 PM,,"7:30 AM to 7:00 pm
8:30 am to 9:00 pm",,,,"8:30 AM to 11 pm
Extended Evening",,8:30 am to 11 pm,,
Arrival Time,,,,,,,,,,,,,
Lightning Lane MultiPass,,,,,"Hollywood Studios
starting at Noon",,,,,,,,
Tier 1,,,,,Slinky Dog,,,,Test Track,,Jungle Cruise,,
Tier 2,,,,,Toy Story Mania,,,,Spaceship Earth,,Pirates,,
Tier 2,,,,,"Earliest avaiable Tier 2
(burner ride)",,,,"Nemo & Friends 
(Burner Ride)",,Magic Carpets of Aladdin (burner ride),,
Individaul Lighting Lane,,,,,,,,,Guardians?,,Tron,,
,,,,,,,,,,,,,
Rope Drop,,,,,Flight of Passage,,,,Frozen,,Peter Pan,,
,,,,,,,,,,,,,
Snacks,,,,,,,,,,,,,
Top 3 Priorities,,,,,"AK - Satu'Ii
Cheeseburger Steamed Pods",,,,,,Gaston's Tavern's Creme Brulee Croissant,,
,,,,,AK - French Fries with Pulled Pork and Cheese - Flame Tree,,,,,,Cheeseburger Spring Rolls - Adventure Land,,
,,,,,HW - Ronto Wrap - Galxys Edge,,,,,,Chipotle BBQ Loaded Fries - Casey's Corner,,
,,,,,,,,,,,Corndog - Sleepy Hollow Refreshments,,
Lunch/Dinner,,,,,,,,,,,,,
Must-Do,,,,,,,,,,,,,
,,,,,"AK - Satu'li Canteen - Noodle Bowl
Cheeseburger Steamed Pods",,,,,,Sleep Hollow - Chicke & Waffle,,
,,,,,,,,,,,Cosmic Rays - Truffle French Onion Burger,,
,,,,,,,,,,,,,
,,,,,Woody's Round up? ,,,,,,,,
,,,,,Woody's Lunch box? ,,,,,,,,
,,,,,,,,,,,,,
,,,,,,,,,,,,,
Snack,,,,,,,,,,,,,
Evening Show,Magic Kingdom Fireworks from Poly,,,,"Fantasmic: 9 pm
World of Ani: 9 pm",,,,Luminous: 9 pm,,"Disney Starlight: 
9 or 11 pm",,`;

        function parseCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim());
            const parsedItinerary = {};
            const parsedTripOverview = {};

            // Helper to get cell value, handling empty strings and quoted commas
            const getCellValue = (rowIdx, col) => {
                const row = lines[rowIdx];
                if (!row) return '';
                // This regex handles commas inside double quotes
                const cells = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                return cells[col] || '';
            };

            // Parse general trip information (rows 1-7)
            const arrivalFlightRow = lines[1].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
            parsedTripOverview.arrivalFlight = {
                date: arrivalFlightRow[2],
                number: arrivalFlightRow[3],
                time: arrivalFlightRow[4]
            };

            const departureFlightRow = lines[2].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
            parsedTripOverview.departureFlight = {
                date: departureFlightRow[2],
                number: departureFlightRow[3],
                time: departureFlightRow[4]
            };

            parsedTripOverview.hotels = [];
            for (let i = 3; i <= 5; i++) {
                const hotelRow = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                if (hotelRow[1]) {
                    parsedTripOverview.hotels.push({
                        name: hotelRow[1],
                        confirmation: hotelRow[2],
                        dates: hotelRow[3]
                    });
                }
            }

            const carServiceRow = lines[6].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
            parsedTripOverview.carService = carServiceRow[1] || 'N/A';

            const strollerRentalRow = lines[7].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
            parsedTripOverview.strollerRental = strollerRentalRow[1] || 'N/A';


            // Row indices for daily itinerary
            const DAY_ROW_IDX = 8;
            const PARK_LOCATION_ROW_IDX = 9;
            const PARK_HOURS_ROW_IDX = 10;
            const LIGHTNING_LANE_MULTIPASS_ROW_IDX = 12;
            const TIER1_ROW_IDX = 13;
            const TIER2_ROW_IDX_1 = 14;
            const TIER2_ROW_IDX_2 = 15;
            const INDIVIDUAL_LL_ROW_IDX = 16;
            const ROPE_DROP_ROW_IDX = 18;
            const SNACKS_HEADER_ROW_IDX = 20;
            const LUNCH_DINNER_HEADER_ROW_IDX = 25;
            const EVENING_SHOW_ROW_IDX = 32;

            const dayHeaders = lines[DAY_ROW_IDX].split(',').map(h => h.trim());

            const dayColumns = [];
            for (let i = 0; i < dayHeaders.length; i++) {
                if (dayHeaders[i].match(/^\d{4}-\d{2}-\d{2}$/)) {
                    dayColumns.push({ date: dayHeaders[i], index: i });
                }
            }

            dayColumns.forEach(dayCol => {
                const date = dayCol.date;
                const colIdx = dayCol.index;

                const getListItems = (startIdx, endIdx, col) => {
                    const items = [];
                    for (let i = startIdx; i <= endIdx; i++) {
                        const item = getCellValue(i, col);
                        if (item && item !== 'Snacks' && item !== 'Lunch/Dinner' && item !== 'Must-Do' && item !== 'Top 3 Priorities') {
                            items.push(item);
                        }
                    }
                    return items.filter(item => item !== '');
                };

                const location = getCellValue(PARK_LOCATION_ROW_IDX, colIdx);
                const parkHours = getCellValue(PARK_HOURS_ROW_IDX, colIdx);
                const lightningLaneMultipass = getCellValue(LIGHTNING_LANE_MULTIPASS_ROW_IDX, colIdx);
                const tier1 = getCellValue(TIER1_ROW_IDX, colIdx);
                const tier2_1 = getCellValue(TIER2_ROW_IDX_1, colIdx);
                const tier2_2 = getCellValue(TIER2_ROW_IDX_2, colIdx);
                const individualLL = getCellValue(INDIVIDUAL_LL_ROW_IDX, colIdx);
                const ropeDrop = getCellValue(ROPE_DROP_ROW_IDX, colIdx);
                const eveningShow = getCellValue(EVENING_SHOW_ROW_IDX, colIdx);

                let snacksContentEndIdx = LUNCH_DINNER_HEADER_ROW_IDX - 1;
                let lunchDinnerContentEndIdx = EVENING_SHOW_ROW_IDX - 1;

                const snackHeaderLaterIdx = lines.findIndex((line, idx) => idx > LUNCH_DINNER_HEADER_ROW_IDX && line.startsWith('Snack,'));
                if (snackHeaderLaterIdx !== -1) {
                    lunchDinnerContentEndIdx = snackHeaderLaterIdx - 1;
                    snacksContentEndIdx = EVENING_SHOW_ROW_IDX - 1;
                }

                const snacks = getListItems(SNACKS_HEADER_ROW_IDX + 1, snacksContentEndIdx, colIdx);
                const lunchDinner = getListItems(LUNCH_DINNER_HEADER_ROW_IDX + 1, lunchDinnerContentEndIdx, colIdx);

                parsedItinerary[date] = {
                    date: date,
                    location: location,
                    parkHours: parkHours,
                    lightningLaneMultipass: lightningLaneMultipass,
                    lightningLaneTiers: {
                        tier1: tier1,
                        tier2: [tier2_1, tier2_2].filter(Boolean).join('; ')
                    },
                    individualLightningLanes: individualLL,
                    ropeDrop: ropeDrop,
                    food: {
                        snacks: snacks,
                        lunchDinner: lunchDinner
                    },
                    eveningShow: eveningShow
                };
            });

            return { itinerary: parsedItinerary, tripOverview: parsedTripOverview };
        }

        // Function to save a specific part of the itinerary to Firestore
        window.saveDataToFirestore = window.debounceSave(async (dataType, dataKey, dataToSave) => {
            if (!window.userId || !window.db) {
                console.error("Firebase not initialized or user not authenticated. Cannot save data.");
                updateStatus("Error: Not authenticated. Cannot save.", true);
                return;
            }

            const docRef = doc(window.db, `artifacts/${__app_id}/users/${window.userId}/itineraryData`, dataKey);
            try {
                updateStatus("Saving...", false);
                await setDoc(docRef, dataToSave, { merge: true }); // Use merge to avoid overwriting the entire document
                updateStatus("Saved!", false);
                console.log(`Document ${dataKey} (${dataType}) successfully saved!`);
            } catch (e) {
                console.error(`Error saving document ${dataKey} (${dataType}): `, e);
                updateStatus(`Error saving: ${e.message}`, true);
            }
        });

        // Function to load all itinerary data from Firestore
        async function loadItineraryFromFirestore() {
            if (!window.userId || !window.db) {
                console.error("Firebase not initialized or user not authenticated. Cannot load data.");
                return;
            }

            const itineraryCollectionRef = collection(window.db, `artifacts/${__app_id}/users/${window.userId}/itineraryData`);

            try {
                // Listen for changes to trip overview
                onSnapshot(doc(itineraryCollectionRef, "tripOverview"), (docSnap) => {
                    if (docSnap.exists()) {
                        window.tripOverview = docSnap.data();
                        console.log("Trip Overview loaded from Firestore:", window.tripOverview);
                        populateTripOverview(window.tripOverview);
                        updateStatus("Itinerary loaded.");
                    } else {
                        console.log("No trip overview found in Firestore. Using initial CSV data.");
                        const { itinerary: csvItinerary, tripOverview: csvTripOverview } = parseCSV(csvData);
                        window.tripOverview = csvTripOverview;
                        populateTripOverview(window.tripOverview);
                        // Save initial CSV data to Firestore if not present
                        window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);
                    }
                }, (error) => {
                    console.error("Error listening to trip overview:", error);
                    updateStatus(`Error loading trip overview: ${error.message}`, true);
                });

                // Listen for changes to daily itineraries
                onSnapshot(itineraryCollectionRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const docId = change.doc.id;
                        if (docId === "tripOverview") return; // Skip trip overview here

                        if (change.type === "added" || change.type === "modified") {
                            window.itineraryData[docId] = change.doc.data();
                            console.log(`Daily itinerary for ${docId} loaded/updated.`);
                            // If the current tab is the one being updated, re-display it
                            if (window.activeDayTab && window.activeDayTab.dataset.date === docId) {
                                displayDayDetails(docId);
                            }
                        } else if (change.type === "removed") {
                            delete window.itineraryData[docId];
                            console.log(`Daily itinerary for ${docId} removed.`);
                            // If the removed tab was active, clear details
                            if (window.activeDayTab && window.activeDayTab.dataset.date === docId) {
                                displayDayDetails(null); // Clear content
                            }
                        }
                    });

                    // Re-render tabs if new dates are added or removed
                    renderDayTabs();

                    // If no tab is active, or the active tab was removed, activate the first one
                    if (!window.activeDayTab || !window.itineraryData[window.activeDayTab.dataset.date]) {
                        const sortedDates = Object.keys(window.itineraryData).sort();
                        if (sortedDates.length > 0) {
                            const firstTabHeader = document.querySelector(`.tab-header[data-date="${sortedDates[0]}"]`);
                            if (firstTabHeader) {
                                firstTabHeader.click();
                            }
                        } else {
                            displayDayDetails(null); // Clear if no data
                        }
                    }
                    updateStatus("Itinerary loaded.");

                }, (error) => {
                    console.error("Error listening to daily itineraries:", error);
                    updateStatus(`Error loading daily itineraries: ${error.message}`, true);
                });

                // Initial load: if no data in Firestore, populate from CSV and save
                const initialDocs = await getDocs(itineraryCollectionRef);
                if (initialDocs.empty) {
                    console.log("No data in Firestore. Populating from CSV and saving.");
                    const { itinerary: csvItinerary, tripOverview: csvTripOverview } = parseCSV(csvData);
                    window.tripOverview = csvTripOverview;
                    window.itineraryData = csvItinerary;

                    // Save trip overview
                    window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);

                    // Save each daily itinerary
                    for (const date in window.itineraryData) {
                        window.saveDataToFirestore('dailyItinerary', date, window.itineraryData[date]);
                    }
                    populateTripOverview(window.tripOverview);
                    renderDayTabs();
                    const sortedDates = Object.keys(window.itineraryData).sort();
                    if (sortedDates.length > 0) {
                        const firstTabHeader = document.querySelector(`.tab-header[data-date="${sortedDates[0]}"]`);
                        if (firstTabHeader) {
                            firstTabHeader.click();
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading itinerary from Firestore:", error);
                updateStatus(`Error loading itinerary: ${error.message}`, true);
            }
        }

        // Function to populate trip overview details
        function populateTripOverview(data) {
            if (flightArrivalInfo) { // Ensure element exists
                if (data.arrivalFlight) {
                    flightArrivalInfo.textContent = `${data.arrivalFlight.number || 'N/A'} on ${data.arrivalFlight.date || 'N/A'} at ${data.arrivalFlight.time || 'N/A'}`;
                } else {
                    flightArrivalInfo.textContent = 'N/A';
                }
            }

            if (flightDepartureInfo) { // Ensure element exists
                if (data.departureFlight) {
                    flightDepartureInfo.textContent = `${data.departureFlight.number || 'N/A'} on ${data.departureFlight.date || 'N/A'} at ${data.departureFlight.time || 'N/A'}`;
                } else {
                    flightDepartureInfo.textContent = 'N/A';
                }
            }

            if (hotelInfoList) { // Ensure element exists
                hotelInfoList.innerHTML = ''; // Clear existing
                if (data.hotels && data.hotels.length > 0) {
                    data.hotels.forEach((hotel, index) => {
                        const li = document.createElement('li');
                        li.classList.add('list-item');
                        li.innerHTML = `<span class="font-semibold" contenteditable="true" data-field="hotel-name" data-index="${index}">${hotel.name || 'N/A'}</span> (<span contenteditable="true" data-field="hotel-dates" data-index="${index}">${hotel.dates || 'N/A'}</span>) - Confirmation: <span contenteditable="true" data-field="hotel-confirmation" data-index="${index}">${hotel.confirmation || 'N/A'}</span>`;
                        hotelInfoList.appendChild(li);
                    });
                } else {
                    hotelInfoList.innerHTML = '<li class="list-item italic text-gray-500">No hotel information available.</li>';
                }
            }

            if (carServiceInfo) { // Ensure element exists
                carServiceInfo.textContent = data.carService || 'N/A';
            }
            if (strollerRentalInfo) { // Ensure element exists
                strollerRentalInfo.textContent = data.strollerRental || 'N/A';
            }

            // Add event listeners for trip overview editable fields
            document.querySelectorAll('#flight-arrival-info, #flight-departure-info, #car-service-info, #stroller-rental-info, #hotel-info [contenteditable="true"]').forEach(el => {
                el.onblur = (event) => {
                    const field = event.target.dataset.field;
                    const index = event.target.dataset.index;
                    let value = event.target.textContent.trim();

                    if (field === 'flight-arrival-info') {
                        // Attempt to parse "UA2451 on 2025-07-23 at 18:25:00"
                        const parts = value.match(/(.+) on (\d{4}-\d{2}-\d{2}) at (\d{2}:\d{2}:\d{2})/);
                        if (parts) {
                            window.tripOverview.arrivalFlight = { number: parts[1], date: parts[2], time: parts[3] };
                        } else {
                            // Fallback if format is unexpected
                            window.tripOverview.arrivalFlight = { number: value, date: '', time: '' };
                        }
                    } else if (field === 'flight-departure-info') {
                        const parts = value.match(/(.+) on (\d{4}-\d{2}-\d{2}) at (\d{2}:\d{2}:\d{2})/);
                        if (parts) {
                            window.tripOverview.departureFlight = { number: parts[1], date: parts[2], time: parts[3] };
                        } else {
                            window.tripOverview.departureFlight = { number: value, date: '', time: '' };
                        }
                    } else if (field === 'car-service-info') {
                        window.tripOverview.carService = value;
                    } else if (field === 'stroller-rental-info') {
                        window.tripOverview.strollerRental = value;
                    } else if (field && index !== undefined) {
                        const hotelIndex = parseInt(index);
                        if (!window.tripOverview.hotels[hotelIndex]) {
                            window.tripOverview.hotels[hotelIndex] = {};
                        }
                        if (field === 'hotel-name') {
                            window.tripOverview.hotels[hotelIndex].name = value;
                        } else if (field === 'hotel-dates') {
                            window.tripOverview.hotels[hotelIndex].dates = value;
                        } else if (field === 'hotel-confirmation') {
                            window.tripOverview.hotels[hotelIndex].confirmation = value;
                        }
                    }
                    window.saveDataToFirestore('tripOverview', 'tripOverview', window.tripOverview);
                };
            });
        }


        // Function to display details for a selected day
        function displayDayDetails(date) {
            const day = window.itineraryData[date];
            if (!day) {
                // Clear content if no data for this date
                if (currentDayDate) currentDayDate.textContent = 'No data for this date.';
                if (detailLocation) detailLocation.textContent = '';
                if (detailParkHours) detailParkHours.textContent = '';
                if (detailLLTier1) detailLLTier1.innerHTML = '';
                if (detailLLTier2) detailLLTier2.innerHTML = '';
                if (detailILL) detailILL.textContent = '';
                if (detailRopeDrop) detailRopeDrop.textContent = '';
                if (detailEveningShow) detailEveningShow.textContent = '';
                if (detailSnacks) detailSnacks.innerHTML = '<li class="list-item italic text-gray-500">No snacks planned.</li>';
                if (detailLunchDinner) detailLunchDinner.innerHTML = '<li class="list-item italic text-gray-500">No lunch/dinner planned.</li>';
                return;
            }

            if (currentDayDate) currentDayDate.textContent = `Itinerary for ${day.date}`;

            // Populate and make editable
            if (detailLocation) {
                detailLocation.textContent = day.location || '';
                detailLocation.setAttribute('contenteditable', 'true');
                detailLocation.onblur = (e) => {
                    day.location = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            if (detailParkHours) {
                detailParkHours.textContent = day.parkHours || '';
                detailParkHours.setAttribute('contenteditable', 'true');
                detailParkHours.onblur = (e) => {
                    day.parkHours = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            if (detailLLTier1) {
                detailLLTier1.innerHTML = `<span class="font-semibold">Tier 1:</span> <span contenteditable="true" data-field="tier1">${day.lightningLaneTiers.tier1 || ''}</span>`;
                detailLLTier1.querySelector('[data-field="tier1"]').onblur = (e) => {
                    day.lightningLaneTiers.tier1 = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            if (detailLLTier2) {
                detailLLTier2.innerHTML = `<span class="font-semibold">Tier 2:</span> <span contenteditable="true" data-field="tier2">${day.lightningLaneTiers.tier2 || ''}</span>`;
                detailLLTier2.querySelector('[data-field="tier2"]').onblur = (e) => {
                    day.lightningLaneTiers.tier2 = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            if (detailILL) {
                detailILL.textContent = day.individualLightningLanes || '';
                detailILL.setAttribute('contenteditable', 'true');
                detailILL.onblur = (e) => {
                    day.individualLightningLanes = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            if (detailRopeDrop) {
                detailRopeDrop.textContent = day.ropeDrop || '';
                detailRopeDrop.setAttribute('contenteditable', 'true');
                detailRopeDrop.onblur = (e) => {
                    day.ropeDrop = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            if (detailEveningShow) {
                detailEveningShow.textContent = day.eveningShow || '';
                detailEveningShow.setAttribute('contenteditable', 'true');
                detailEveningShow.onblur = (e) => {
                    day.eveningShow = e.target.textContent.trim();
                    window.saveDataToFirestore('dailyItinerary', date, day);
                };
            }

            displayFoodLists(date); // Call this to handle snacks and meals
        }

        // Helper to re-render just the food lists after an edit to handle empty items
        function displayFoodLists(date) {
            const day = window.itineraryData[date];
            if (!day) return;

            if (detailSnacks) {
                detailSnacks.innerHTML = '';
                if (day.food.snacks && day.food.snacks.length > 0) {
                    day.food.snacks.forEach((snack, index) => {
                        const li = document.createElement('li');
                        li.classList.add('list-item');
                        const span = document.createElement('span');
                        span.textContent = snack;
                        span.setAttribute('contenteditable', 'true');
                        span.dataset.field = 'snack';
                        span.dataset.index = index;
                        li.appendChild(span);
                        detailSnacks.appendChild(li);
                    });
                }
                // Always add an empty editable item for adding new entries
                const newSnackLi = document.createElement('li');
                newSnackLi.classList.add('list-item');
                const newSnackSpan = document.createElement('span');
                newSnackSpan.textContent = '';
                newSnackSpan.setAttribute('contenteditable', 'true');
                newSnackSpan.dataset.field = 'snack';
                newSnackSpan.dataset.index = (day.food.snacks ? day.food.snacks.length : 0).toString();
                newSnackLi.appendChild(newSnackSpan);
                detailSnacks.appendChild(newSnackLi);

                // Re-attach blur listeners for snacks
                detailSnacks.querySelectorAll('[contenteditable="true"]').forEach(el => {
                    el.onblur = (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const value = e.target.textContent.trim();
                        if (!day.food.snacks) day.food.snacks = [];

                        if (value === '' && day.food.snacks[index] !== undefined) {
                            // If an existing item is cleared, remove it
                            day.food.snacks.splice(index, 1);
                        } else if (value !== '' && day.food.snacks[index] === undefined) {
                            // If a new item is added to an empty slot
                            day.food.snacks.push(value);
                        } else if (value !== '') {
                            // If an existing item is modified
                            day.food.snacks[index] = value;
                        }
                        day.food.snacks = day.food.snacks.filter(item => item !== ''); // Final cleanup
                        window.saveDataToFirestore('dailyItinerary', date, day);
                        displayFoodLists(date); // Re-render to update indices and add new empty input
                    };
                });
            }


            if (detailLunchDinner) {
                detailLunchDinner.innerHTML = '';
                if (day.food.lunchDinner && day.food.lunchDinner.length > 0) {
                    day.food.lunchDinner.forEach((meal, index) => {
                        const li = document.createElement('li');
                        li.classList.add('list-item');
                        const span = document.createElement('span');
                        span.textContent = meal;
                        span.setAttribute('contenteditable', 'true');
                        span.dataset.field = 'meal';
                        span.dataset.index = index;
                        li.appendChild(span);
                        detailLunchDinner.appendChild(li);
                    });
                }
                // Always add an empty editable item for adding new entries
                const newMealLi = document.createElement('li');
                newMealLi.classList.add('list-item');
                const newMealSpan = document.createElement('span');
                newMealSpan.textContent = '';
                newMealSpan.setAttribute('contenteditable', 'true');
                newMealSpan.dataset.field = 'meal';
                newMealSpan.dataset.index = (day.food.lunchDinner ? day.food.lunchDinner.length : 0).toString();
                newMealLi.appendChild(newMealSpan);
                detailLunchDinner.appendChild(newMealLi);

                // Re-attach blur listeners for lunch/dinner
                detailLunchDinner.querySelectorAll('[contenteditable="true"]').forEach(el => {
                    el.onblur = (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const value = e.target.textContent.trim();
                        if (!day.food.lunchDinner) day.food.lunchDinner = [];

                        if (value === '' && day.food.lunchDinner[index] !== undefined) {
                            day.food.lunchDinner.splice(index, 1);
                        } else if (value !== '' && day.food.lunchDinner[index] === undefined) {
                            day.food.lunchDinner.push(value);
                        } else if (value !== '') {
                            day.food.lunchDinner[index] = value;
                        }
                        day.food.lunchDinner = day.food.lunchDinner.filter(item => item !== '');
                        window.saveDataToFirestore('dailyItinerary', date, day);
                        displayFoodLists(date);
                    };
                });
            }
        }


        // Function to render day tabs
        function renderDayTabs() {
            const sortedDates = Object.keys(window.itineraryData).sort();
            if (dayTabsContainer) { // Ensure element exists
                dayTabsContainer.innerHTML = ''; // Clear existing tabs

                sortedDates.forEach(date => {
                    const tabHeader = document.createElement('div');
                    tabHeader.textContent = date;
                    tabHeader.classList.add('tab-header');
                    tabHeader.dataset.date = date;

                    tabHeader.addEventListener('click', () => {
                        if (window.activeDayTab) {
                            window.activeDayTab.classList.remove('active');
                        }
                        tabHeader.classList.add('active');
                        window.activeDayTab = tabHeader;
                        displayDayDetails(date);
                    });
                    dayTabsContainer.appendChild(tabHeader);
                });
            }
        }

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-4 shadow-lg">
        <div class="container flex justify-between items-center">
            <h1 class="text-3xl font-bold">Disney World Itinerary</h1>
            <span class="text-sm opacity-80" id="user-id-display"></span>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <!-- Status Message -->
        <div id="status-message" class="status-message hidden mb-4"></div>

        <!-- General Trip Information Card -->
        <div class="card mb-6">
            <h2 class="text-2xl font-semibold text-center mb-4 text-indigo-700">Trip Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2 text-purple-600">Flights</h3>
                    <p><strong class="text-indigo-600">Arrival:</strong> <span id="flight-arrival-info" contenteditable="true"></span></p>
                    <p><strong class="text-indigo-600">Departure:</strong> <span id="flight-departure-info" contenteditable="true"></span></p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2 text-purple-600">Hotels</h3>
                    <ul id="hotel-info" class="list-disc list-inside">
                        <!-- Hotel details will be injected here -->
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2 text-purple-600">Other Services</h3>
                    <p><strong class="text-indigo-600">Car Service:</strong> <span id="car-service-info" contenteditable="true"></span></p>
                    <p><strong class="text-indigo-600">Stroller Rental:</strong> <span id="stroller-rental-info" contenteditable="true"></span></p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <h2 class="text-2xl font-semibold text-center mb-4 text-indigo-700">Daily Itinerary</h2>
            <!-- Tab Headers -->
            <div id="day-tabs" class="flex flex-wrap justify-center overflow-x-auto whitespace-nowrap pb-2 -mb-1">
                <!-- Day tab headers will be injected here by JavaScript -->
            </div>

            <!-- Tab Content -->
            <div id="itinerary-details" class="tab-content-container">
                <h2 id="current-day-date" class="text-2xl font-bold mb-4 text-center text-purple-700"></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="detail-item">
                        <strong class="text-xl block mb-1">Location:</strong>
                        <p id="detail-location" class="text-lg"></p>
                    </div>
                    <div class="detail-item">
                        <strong class="text-xl block mb-1">Park Hours:</strong>
                        <p id="detail-park-hours" class="text-lg"></p>
                    </div>
                    <div class="detail-item">
                        <strong class="text-xl block mb-1">Lightning Lane Tiers:</strong>
                        <p id="detail-ll-tier1" class="text-base mb-1"><span class="font-semibold">Tier 1:</span> </p>
                        <p id="detail-ll-tier2" class="text-base"><span class="font-semibold">Tier 2:</span> </p>
                    </div>
                    <div class="detail-item">
                        <strong class="text-xl block mb-1">Individual Lightning Lanes:</strong>
                        <p id="detail-ill" class="text-lg"></p>
                    </div>
                    <div class="detail-item">
                        <strong class="text-xl block mb-1">Rope Drop:</strong>
                        <p id="detail-rope-drop" class="text-lg"></p>
                    </div>
                    <div class="detail-item">
                        <strong class="text-xl block mb-1">Evening Show:</strong>
                        <p id="detail-evening-show" class="text-lg"></p>
                    </div>
                </div>

                <div class="mt-6 border-t pt-6 border-gray-200">
                    <strong class="text-xl block mb-2 text-indigo-700">Food:</strong>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Snacks:</h3>
                            <ul id="detail-snacks" class="list-disc list-inside">
                                <!-- Snacks will be injected here -->
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Lunch/Dinner:</h3>
                            <ul id="detail-lunch-dinner" class="list-disc list-inside">
                                <!-- Lunch/Dinner will be injected here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-8">
        <div class="container">
            &copy; 2025 Disney World Itinerary App. All rights reserved.
        </div>
    </footer>
</body>
</html>
